<!DOCTYPE html>
<html>
<head>
    <title>Text Adventure Editor</title>
    <style>
        .node {
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 180px;
            height: 120px;
            position: absolute;
            background-color: white;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .text-event { border-top: 3px solid #4285f4; }
        .chooser { border-top: 3px solid #ea4335; }
        .option { border-top: 3px solid #34a853; }
        .node-title {
            font-weight: bold;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .connector {
            width: 15px;
            height: 15px;
            background-color: #ccc;
            border-radius: 50%;
            cursor: pointer;
        }
        #canvas {
            position: relative;
            width: 100%;
            height: 800px;
            background-color: #f9f9f9;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.6/js/jsplumb.min.js"></script>
</head>
<body>
    <div>
        <button id="add-text-event">Add Text Event</button>
        <button id="add-chooser">Add Chooser</button>
        <button id="add-option">Add Option</button>
        <button id="export">Export JSON</button>
    </div>
    <div id="canvas"></div>
    
    <script>
        // Initialize jsPlumb
        const jsPlumbInstance = jsPlumb.getInstance();
        
        // Initialize the editor
        document.addEventListener('DOMContentLoaded', function() {
            // Setup jsPlumb defaults
            jsPlumbInstance.importDefaults({
                Connector: ['Bezier', { curviness: 50 }],
                Anchors: ['Right', 'Left'],
                Endpoint: ['Dot', { radius: 5 }],
                EndpointStyle: { fill: '#ccc' },
                PaintStyle: { stroke: '#5c96bc', strokeWidth: 2 },
                HoverPaintStyle: { stroke: '#1e8151' },
                ConnectionOverlays: [
                    ['Arrow', { location: 1, width: 10, length: 10 }]
                ]
            });
            
            // Make nodes draggable
            jsPlumbInstance.draggable(document.querySelectorAll('.node'), {
                containment: 'parent'
            });
            
            // Add button event listeners
            document.getElementById('add-text-event').addEventListener('click', () => {
                addNode('text-event', 'Text Event');
            });
            
            document.getElementById('add-chooser').addEventListener('click', () => {
                addNode('chooser', 'Chooser');
            });
            
            document.getElementById('add-option').addEventListener('click', () => {
                addNode('option', 'Option');
            });
            
            document.getElementById('export').addEventListener('click', exportGraph);
            
            // Create a simple demo
            createDemo();
        });
        
        let nodeCounter = 1;
        
        function addNode(type, title) {
            const id = `node-${nodeCounter++}`;
            const node = document.createElement('div');
            node.id = id;
            node.className = `node ${type}`;
            node.style.left = `${100 + Math.random() * 400}px`;
            node.style.top = `${100 + Math.random() * 400}px`;
            
            // Create node content based on type
            let content = `<div class="node-title">${title}</div>`;
            
            if (type === 'text-event') {
                content += `
                    <div>ID: <input type="text" class="node-id" value="text${id.split('-')[1]}"></div>
                    <div>Content: <textarea class="node-content"></textarea></div>
                `;
            } else if (type === 'chooser') {
                content += `
                    <div>ID: <input type="text" class="node-id" value="choice${id.split('-')[1]}"></div>
                    <div>Prompt: <textarea class="node-prompt"></textarea></div>
                `;
            } else if (type === 'option') {
                content += `
                    <div>Name: <input type="text" class="option-name" value="Option"></div>
                    <div><label><input type="checkbox" class="option-hidden"> Hidden</label></div>
                `;
            }
            
            node.innerHTML = content;
            document.getElementById('canvas').appendChild(node);
            
            // Make node draggable
            jsPlumbInstance.draggable(node);
            
            // Add endpoints based on node type
            if (type === 'text-event') {
                jsPlumbInstance.addEndpoint(id, {
                    isSource: true,
                    anchor: 'Right',
                    maxConnections: 1
                });
                jsPlumbInstance.addEndpoint(id, {
                    isTarget: true,
                    anchor: 'Left'
                });
            } else if (type === 'chooser') {
                jsPlumbInstance.addEndpoint(id, {
                    isSource: true,
                    anchor: 'Right',
                    maxConnections: -1
                });
                jsPlumbInstance.addEndpoint(id, {
                    isTarget: true,
                    anchor: 'Left'
                });
            } else if (type === 'option') {
                jsPlumbInstance.addEndpoint(id, {
                    isSource: true,
                    anchor: 'Right',
                    maxConnections: 1
                });
                jsPlumbInstance.addEndpoint(id, {
                    isTarget: true,
                    anchor: 'Left'
                });
            }
            
            return node;
        }
        
        function createDemo() {
            // Add intro node
            const intro = addNode('text-event', 'Text Event');
            intro.querySelector('.node-id').value = 'intro';
            intro.querySelector('.node-content').value = 'You stand at a crossroads.';
            
            // Add choice node
            const choice = addNode('chooser', 'Chooser');
            choice.style.top = '250px';
            choice.style.left = '200px';
            choice.querySelector('.node-id').value = 'first_choice';
            choice.querySelector('.node-prompt').value = 'Which path will you take?';
            
            // Connect intro to choice
            jsPlumbInstance.connect({
                source: intro.id,
                target: choice.id
            });
            
            // Add path nodes
            const leftPath = addNode('text-event', 'Text Event');
            leftPath.style.top = '400px';
            leftPath.style.left = '100px';
            leftPath.querySelector('.node-id').value = 'left_path';
            leftPath.querySelector('.node-content').value = 'You chose the left path.';
            
            const rightPath = addNode('text-event', 'Text Event');
            rightPath.style.top = '400px';
            rightPath.style.left = '300px';
            rightPath.querySelector('.node-id').value = 'right_path';
            rightPath.querySelector('.node-content').value = 'You chose the right path.';
            
            // Connect choice to paths
            jsPlumbInstance.connect({
                source: choice.id,
                target: leftPath.id,
                overlays: [
                    ['Label', { label: 'Left', location: 0.5 }]
                ]
            });
            
            jsPlumbInstance.connect({
                source: choice.id,
                target: rightPath.id,
                overlays: [
                    ['Label', { label: 'Right', location: 0.5 }]
                ]
            });
        }
        
        function exportGraph() {
            const nodes = document.querySelectorAll('.node');
            const data = {
                nodes: []
            };
            
            // Collect node data
            nodes.forEach(node => {
                const type = node.className.replace('node ', '');
                
                if (type === 'text-event') {
                    data.nodes.push({
                        type: 'TextEvent',
                        id: node.querySelector('.node-id').value,
                        content: node.querySelector('.node-content').value,
                        nextEvent: null // Will be filled in after collecting connections
                    });
                } else if (type === 'chooser') {
                    data.nodes.push({
                        type: 'Chooser',
                        id: node.querySelector('.node-id').value,
                        prompt: node.querySelector('.node-prompt').value,
                        options: [] // Will be filled in after collecting connections
                    });
                } else if (type === 'option') {
                    data.nodes.push({
                        type: 'Option',
                        name: node.querySelector('.option-name').value,
                        hidden: node.querySelector('.option-hidden').checked,
                        trigger: null // Will be filled in after collecting connections
                    });
                }
            });
            
            // Process connections
            jsPlumbInstance.getConnections().forEach(conn => {
                const sourceId = conn.source.id;
                const targetId = conn.target.id;
                
                const sourceNode = document.getElementById(sourceId);
                const targetNode = document.getElementById(targetId);
                
                const sourceType = sourceNode.className.replace('node ', '');
                const targetType = targetNode.className.replace('node ', '');
                
                const sourceDataId = sourceNode.querySelector('.node-id')?.value;
                const targetDataId = targetNode.querySelector('.node-id')?.value;
                
                // Find nodes in data array
                const sourceData = data.nodes.find(n => n.id === sourceDataId);
                const targetData = data.nodes.find(n => n.id === targetDataId);
                
                if (sourceData && targetData) {
                    if (sourceType === 'text-event') {
                        sourceData.nextEvent = targetDataId;
                    } else if (sourceType === 'chooser') {
                        // For simplicity, create an option with connection overlay label
                        const overlayLabel = conn.getOverlay('label')?.getLabel() || 'Option';
                        sourceData.options.push({
                            name: overlayLabel,
                            hidden: false,
                            trigger: targetDataId
                        });
                    } else if (sourceType === 'option') {
                        sourceData.trigger = targetDataId;
                    }
                }
            });
            
            // Output JSON
            console.log(JSON.stringify(data, null, 2));
            
            // Download as file
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "adventure.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>
</html>